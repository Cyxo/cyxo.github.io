<!doctype html><html lang=en-us>
<head><title>
Discord's Image Preview - A Boon for Phishing Attacks |
Cyxo's Tech Blog</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="How to hijack Discord's preview of images 
    ">
<meta property="og:title" content="Discord's Image Preview - A boon for Phishing Attacks">
<meta property="og:description" content="How to hijack Discord's preview of images ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.cyxo.cf/misc/discord-image-cache/"><meta property="article:section" content="Misc">
<meta property="article:published_time" content="2022-01-15T00:00:00+00:00">
<meta property="article:modified_time" content="2022-01-15T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Discord's Image Preview - A boon for Phishing Attacks">
<meta name=twitter:description content="How to hijack Discord's preview of images ">
<meta itemprop=name content="Discord's Image Preview - A boon for Phishing Attacks">
<meta itemprop=description content="How to hijack Discord's preview of images "><meta itemprop=datePublished content="2022-01-15T00:00:00+00:00">
<meta itemprop=dateModified content="2022-01-15T00:00:00+00:00">
<meta itemprop=wordCount content="890">
<meta itemprop=keywords content="phishing,">
<link rel=canonical href=https://blog.cyxo.cf/misc/discord-image-cache/>
<link rel=icon type=image/png href=https://blog.cyxo.cf/image/favicon.ico>
<link rel=stylesheet href=/css/font-awesome.min.css>
<link rel=stylesheet href=/css/bulma.min.css>
<script src=/js/ramium.js></script>
<link rel=stylesheet href=/css/ramium.css>
</head>
<body><nav class="navbar is-dark" role=navigation aria-label="main navigation">
<div class=navbar-brand>
<a class=navbar-item href=/>
<strong>Cyxo's Tech Blog </strong>
</a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
</div>
<div id=navbarBasicExample class=navbar-menu>
<div class=navbar-start>
<a class=navbar-item href=/>Home</a>
<div class="navbar-item has-dropdown is-hoverable">
<a class=navbar-link>This Blog</a>
<div class=navbar-dropdown>
<a class=navbar-item href=/tags/>All Tags</a>
<a class=navbar-item href=/sections/>All Sections</a>
<a class=navbar-item href=/posts/>All Posts</a>
</div>
</div>
<a class=navbar-item href=/author/>Author</a>
</div>
<div class=navbar-end>
<a class="navbar-item navgithub" href=https://github.com/Cyxo/ target=_blank>
<i class="fa fa-github fa-2x"></i>
</a>
</div>
</div>
</nav><div class="columns is-centered">
<div id=page-body class="column is-7">
<div class="content blog">
<h1>Discord's Image Preview - A Boon for Phishing Attacks</h1>
<div id=infobar class="level is-mobile">
<div class=level-left>
<div class=level-item>
<p class="subtitle info date">Jan 15, 2022
</p>
</div>
<div class=level-item>
<p class="subtitle info">
5 mins read
</p>
</div>
</div>
<div class="level-right is-hidden-touch">
<div class=tags>
<a class="tag is-dark is-rounded" href=/tags/phishing>Phishing</a>
</div>
</div>
</div>
<div class="tags is-hidden-desktop">
<a class="tag is-dark is-rounded" href=/tags/phishing>Phishing</a>
</div>
<div class=blog-text>
<h2 id=intro>Intro</h2>
<p>Phishing attacks on Discord are a big trend right now and hacked accounts sending fake Free Nitro links have become part of the landscape of Discord servers.</p>
<p>Fortunately people are starting to be more aware of phishing attacks, and the hackers start to lack realistic domain names for their phishing attacks (and thus we get links like <code>https://discqrde.club/boost</code> <em>- please don&rsquo;t check this</em>)</p>
<p>So I was wondering if hackers would end up finding better ways to trick their targets using features from Discord. And for this reason, I started looking at how Discord&rsquo;s image preview works.</p>
<p>When you send a link that leads to an image on Discord, the application will replace the URL by a preview of the actual image. And I know it&rsquo;s not just your computer fetching the image because the preview is downscaled if your image was too big. So there must be a bot from Discord that grabs the image, downscales it if needed, and returns a link to some Discord server-side cache with the preview of your image. So it might be possible to send an image link to the user that will display a totally different page when they open the image in their browser.</p>
<h2 id=studying-discords-image-bot>Studying Discord&rsquo;s image bot</h2>
<p>In order to find solid evidence that there is a bot from Discord and try learn how it works, I set up a small web server based on Flask to send an image and record the incoming traffic :</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Flask, send_file, request

app <span style=color:#f92672>=</span> Flask(__name__)

<span style=color:#a6e22e>@app</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#34;/test&lt;whatever&gt;.jpg&#34;</span>)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_image</span>(whatever):
    ua <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;User-Agent&#34;</span>)
    print(ua)
    <span style=color:#66d9ef>return</span> send_file(<span style=color:#e6db74>&#34;test.jpg&#34;</span>, mimetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span>)

app<span style=color:#f92672>.</span>run(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0.0.0.0&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>4444</span>)
</code></pre></div><p>Then I sent a link to <code>http://[mydomain]:4444/test1.jpg</code> and it got converted to a preview of my <code>test.jpg</code> file by Discord. At the same time, I recorded the following logs in my console:</p>
<pre tabindex=0><code>Mozilla/5.0 (compatible; Discordbot/2.0; +https://discordapp.com)
35.196.132.85 - - [15/Jan/2022 18:59:50] &quot;GET /test1.jpg HTTP/1.1&quot; 200 -

Mozilla/5.0 (Macintosh; Intel Mac OS X 11.6; rv:92.0) Gecko/20100101 Firefox/92.0
35.196.13.1 - - [15/Jan/2022 18:59:53] &quot;GET /test1.jpg HTTP/1.1&quot; 200 -
</code></pre><blockquote>
<p>Note: at the beginning, I tried sending links without a domain name, but Discord didn&rsquo;t want to show their previews. Anyway with <a href=https://ngrok.com/>ngrok</a> it&rsquo;s fairly easy to get a domain name pointing to your machine.</p>
</blockquote>
<p>So here we got two different User-Agent and IP adresses (which are owned by Discord, you can check using nslookup or whois). One of the User-Agent is easily recognizable, but the other one could look like a regular Firefox browser on a Macintosh computer.</p>
<p>Interestingly, Discord only checks the link the first time and then stores the preview in their cache, so for testing purposes I added the <code>whatever</code> parameter so that I could get as many test links as I wanted. Even if your server goes down or the content on the link changes, Discord will send the cached preview. Can we exploit that to display a preview different from the actual link? Well not really, since the cache lasts less than an hour. But that&rsquo;s a good start.</p>
<p>To go deeper, I edited the python server like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_image</span>(whatever):
    ua <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>headers<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;User-Agent&#34;</span>)
    print(ua)
    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;Discordbot&#34;</span> <span style=color:#f92672>in</span> ua:
        print(<span style=color:#e6db74>&#34;Discordbot went there&#34;</span>)
        <span style=color:#66d9ef>return</span> send_file(<span style=color:#e6db74>&#34;test.jpg&#34;</span>, mimetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span>)
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;placeholder&#34;</span>
</code></pre></div><p>When I sent a new link, it replaced the link with a loading animation, but the preview never loaded and I ended up with their beautiful poop image:</p>
<p><img src=/image/misc/discord_poop.png alt="Discord&rsquo;s poop placeholder"></p>
<p>At the same time on my server, I got the usual connection from Discordbot 2.0, and then I got a continuous flow of requests from different IP adresses with the Macintosh user agent. So my guess is that Discordbot checks the MIME type of the link, and if it&rsquo;s an image, it asks the Macintosh bot to make a preview.</p>
<h2 id=hijacking-the-preview>Hijacking the preview</h2>
<p>Now that we understand a bit more how Discord generates the preview of an image link, let&rsquo;s see how we could trick the user and show them a different content in their browser.</p>
<p>First, we can consider the previous experiment as a satisfying phishing method: seeing the poop image instead of a preview, the user will probably open the link in their browser and see the placeholder instead.</p>
<p>But I tried to modify the server once again to send the real image to Macintosh user agents as well:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#34;Discordbot&#34;</span> <span style=color:#f92672>in</span> ua <span style=color:#f92672>or</span> <span style=color:#e6db74>&#34;Macintosh&#34;</span> <span style=color:#f92672>in</span> ua:
    <span style=color:#66d9ef>return</span> send_file(<span style=color:#e6db74>&#34;test.jpg&#34;</span>, mimetype<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;image/jpeg&#34;</span>)
<span style=color:#66d9ef>else</span>:
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;placeholder&#34;</span>
</code></pre></div><blockquote>
<p>Yes this makes Mac users invulnerable, but I don&rsquo;t really care since this is just a proof of concept.</p>
</blockquote>
<p>So now the preview shows correctly in Discord, and when you open the image in the browser, it shows our placeholder!</p>
<p>All there is left to do is get creative to find ways to trick the user into opening our image in their browser:</p>
<ul>
<li>As I said earlier, Discord&rsquo;s poop placeholder could already be enough</li>
<li>The image could contain really small text that&rsquo;s hard to read</li>
<li>The fake preview could be a GIF of Discord&rsquo;s loading to make the user think it loads forever</li>
<li>And if the preview looks &ldquo;broken&rdquo;, the user may not be surprised to see a file (an image of course <em>ahem</em>) downloading in their browser or to see a (very legitimate) Discord authentication page.</li>
</ul>
<p>So I hope I&rsquo;ve been able to convince you of the risks behind Discord&rsquo;s image preview. I already heard about some people. Feel free to try it yourself (for education purposes of course).</p>
</div>
</div><div id=social-media-share class=has-text-centered>
<p><i>Sharing is caring!</i></p>
<br>
<div class=share-buttons>
<a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Facebook. Opens in a new window.">
<img src=/img/icons/45px/facebook.png>
</a>
<a href="https://twitter.com/intent/tweet?text=Discord%27s%20Image%20Preview%20-%20A%20boon%20for%20Phishing%20Attacks&url=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Twitter. Opens in a new window.">
<img src=/img/icons/45px/twitter.png>
</a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Reddit. Opens in a new window.">
<img src=/img/icons/45px/reddit.png>
</a>
<a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Pinterest. Opens in a new window.">
<img src=/img/icons/45px/pinterest.png>
</a>
<a href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Tumblr. Opens in a new window.">
<img src=/img/icons/45px/tumblr.png>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f
			&title=Discord%27s%20Image%20Preview%20-%20A%20boon%20for%20Phishing%20Attacks&summary=Intro%20Phishing%20attacks%20on%20Discord%20are%20a%20big%20trend%20right%20now%20and%20hacked%20accounts%20sending%20fake%20Free%20Nitro%20links%20have%20become%20part%20of%20the%20landscape%20of%20Discord%20servers.%0aFortunately%20people%20are%20starting%20to%20be%20more%20aware%20of%20phishing%20attacks%2c%20and%20the%20hackers%20start%20to%20lack%20realistic%20domain%20names%20for%20their%20phishing%20attacks%20%28and%20thus%20we%20get%20links%20like%20https%3a%2f%2fdiscqrde.&source=rafed123.github.io" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on LinkedIn. Opens in a new window.">
<img src=/img/icons/45px/linkedin.png>
</a>
<a href="mailto:?subject=Discord%27s%20Image%20Preview%20-%20A%20boon%20for%20Phishing%20Attacks&body=Check out this site https%3a%2f%2fblog.cyxo.cf%2fmisc%2fdiscord-image-cache%2f" title="Share via Email. Opens in a new window.">
<img src=/img/icons/45px/mail.png>
</a>
</div>
</div>
<br>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
</div>
</div>
<footer class="footer has-background-dark">
<div class="content has-text-centered has-text-white">
<p>
© 2020 Ramium. Powered by
<a class=has-text-light href=https://github.com/gohugoio/hugo target=_blank>
Hugo</a>. Theme
<a class=has-text-light href=https://github.com/rafed123/ramium/ target=_blank>
Ramium.
</a>
</p>
</div>
</footer>
</body>
</html>