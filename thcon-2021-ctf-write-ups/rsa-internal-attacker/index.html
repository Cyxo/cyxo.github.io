<!doctype html><html lang=en-us><head><title>THCon21 - Rsa Internal Attacker |
Cyxo's Tech Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="A RSA cryptography challenge from THCon21
    "><meta property="og:title" content="THCon21 - Rsa internal attacker"><meta property="og:description" content="A RSA cryptography challenge from THCon21"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.cyxo.cf/thcon-2021-ctf-write-ups/rsa-internal-attacker/"><meta property="article:section" content="THCon-2021-CTF-Write-Ups"><meta property="article:published_time" content="2021-06-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="THCon21 - Rsa internal attacker"><meta name=twitter:description content="A RSA cryptography challenge from THCon21"><meta itemprop=name content="THCon21 - Rsa internal attacker"><meta itemprop=description content="A RSA cryptography challenge from THCon21"><meta itemprop=datePublished content="2021-06-17T00:00:00+00:00"><meta itemprop=dateModified content="2021-06-17T00:00:00+00:00"><meta itemprop=wordCount content="606"><meta itemprop=keywords content="cryptography,"><link rel=canonical href=https://blog.cyxo.cf/thcon-2021-ctf-write-ups/rsa-internal-attacker/><link rel=icon type=image/png href=https://blog.cyxo.cf/image/favicon.ico><link rel=stylesheet href=/css/font-awesome.min.css><link rel=stylesheet href=/css/bulma.min.css><script src=/js/ramium.js></script><link rel=stylesheet href=/css/ramium.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><nav class="navbar is-dark" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=/><strong>Cyxo's Tech Blog</strong></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><a class=navbar-item href=/>Home</a><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>This Blog</a><div class=navbar-dropdown><a class=navbar-item href=/tags/>All Tags</a>
<a class=navbar-item href=/sections/>All Sections</a>
<a class=navbar-item href=/posts/>All Posts</a></div></div><a class=navbar-item href=/author/>Author</a></div><div class=navbar-end><a class="navbar-item navgithub" href=https://github.com/Cyxo/ target=_blank><i class="fa fa-github fa-2x"></i></a></div></div></nav><div class="columns is-centered"><div id=page-body class="column is-7"><div class="content blog"><h1>THCon21 - Rsa Internal Attacker</h1><div id=infobar class="level is-mobile"><div class=level-left><div class=level-item><p class="subtitle info date">Jun 17, 2021</p></div><div class=level-item><p class="subtitle info">3 mins read</p></div></div><div class="level-right is-hidden-touch"><div class=tags><a class="tag is-dark is-rounded" href=/tags/cryptography>Cryptography</a></div></div></div><div class="tags is-hidden-desktop"><a class="tag is-dark is-rounded" href=/tags/cryptography>Cryptography</a></div><div class=blog-text><h1 id=thcon21---blacklisted>THCon21 - Blacklisted</h1><p><a href=../>Go back to write-ups list</a></p><blockquote><p><strong>Category:</strong> Cryptography</p><p><strong>Creator:</strong> Nico</p><p><strong>Description:</strong></p><p>I&rsquo;ve found this rsa implementation, it is quite strange. I have a public/private key and I&rsquo;ve also intercepted a ciphertext but infortunately it was not for me, so I can&rsquo;t read it. But I&rsquo;am really curious, can you decrypt it ? :)</p><p><strong>Attachments:</strong></p><ul><li><a href=/files/thcon21/chall.py>chall.py</a></li><li><a href=/files/thcon21/output.txt>output.txt</a></li></ul></blockquote><h2 id=analysing-the-script>Analysing the script</h2><p>The script attached to this challenge generates two prime numbers <code>p</code> and <code>q</code>, and the a modulus <code>n = p*q</code>. This modulus is common for both the users created afterwards.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py>p <span style=color:#f92672>=</span> getPrime(<span style=color:#ae81ff>1024</span>)
q <span style=color:#f92672>=</span> getPrime(<span style=color:#ae81ff>1024</span>)
n <span style=color:#f92672>=</span> p <span style=color:#f92672>*</span> q
e_a, d_a <span style=color:#f92672>=</span> new_user(p, q)
e_b, d_b <span style=color:#f92672>=</span> new_user(p, q)
</code></pre></div><p>Only <code>e</code> (and therefore <code>d</code>) is different for both users. So let&rsquo;s do some quick maths. If we want to find our boss' <code>d</code> from their <code>e</code> and <code>n</code>, we either need to find <code>p</code> and <code>q</code>, or <code>œÜ</code>. Here are the basic formulas linking them:</p><p>$$ \begin{cases} n = p \times q \\ \phi = (p - 1) \times (q - 1) \end{cases} $$</p><p>With some transformation, we can get rid of <code>q</code> and get an expression of <code>p</code> depending on <code>n</code> and <code>œÜ</code>.</p><p>$$ \phi = (p-1)\times(\frac{n}{p} - 1) \\ \Longleftrightarrow p\phi = (p-1)(n-p) \\ \Longleftrightarrow p^2 - (n+1)p + n - \phi = 0 $$</p><p>Well, we have a quadratic equation with <code>p</code> being an integer. This was a bit surprising, and I didn&rsquo;t really know what to expect. Now let&rsquo;s use one last formula : the formula that defines d</p><p>$$ e \times d = 1 \mod \phi $$</p><p>In other words, there exist a natural number k such as</p><p>$$ e \times d = k \times \phi + 1 $$</p><p>So now, if we bruteforce <code>k</code>, knowing our own <code>e</code> and <code>d</code>, we can find the <code>œÜ</code>, which was common to both my key and the boss' key, and therefore <code>p</code> and <code>q</code>. And how do I know whether it&rsquo;s the right <code>œÜ</code> or not? It&rsquo;s the right <code>œÜ</code> if the solution <code>p</code> of the quadratic equation above using this <code>œÜ</code> is an integer!</p><p>Now let&rsquo;s code the bruteforce script to find a <code>œÜ</code> that matches, using the info in <code>output.txt</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#f92672>from</span> Crypto.Util.number <span style=color:#f92672>import</span> inverse, long_to_bytes

e1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x8095</span>
e2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x22bb</span>
d1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x21a31ccbce8117f468e9c26e3a404659d585ea166606c85ff192466b8dd4d9650b110addef35e3effdf8cb8710235cf5843e688e977be0d32842e0b4fa493f451ad8d77d35672696cf4373eaa0c0093a6a0baa348f790fc466be559bd90e788505b795026df6e991f6e8769565e06f472a445676e2c99240eccab25cd44433e8a083e66912c7a81c81c190470188c699c1a24dac441956b46aa364623f2c78c4ffca49e89f8a6f6edc51140e744f80a968fa80901fc91b88d491829b334542fd3ef460ddfa9a729d981b0ae9fa12bd0901c919972020b5f9e661b34a914fff85732e45718a2d216018507e7406aed4543096df76ca6fcfa4ab5dd21a84f162fd</span>
n <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x8d926c44899930f8f3fc3ea04cb9dfa7eb309b6d8e932b531007c4d8479e1dd227365087feeced8f854b1b54cc947182ee2241fe526c758e630b44e0c196ce8dc0995124f94755b0601d3454f89f178db2ffb3adeafcac2f49b656aace2acdb63afcd62a8847aadc55ca2452dff8c65ea5bfcfe03411f3b63a2bc4b244126259e2e845c68f8c1cd2d275bd2e344d35da542503c72f153ded14f766efecdfc98605e6963c4b1a7197de9e56b4b61ca1ab648265e6775819935a005a089eff04c27083d385e8d73ebf56b47f875c5fa9984e026914e1cbfc02205e75d02dc0da392700b536bf0fc8decd043736441e69fecc696b2127589f2ac9700e30c4dc88ef</span>
c <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x2118ee5b546b529c6b8d8fba1638f046006d7de2c10571d179af958f65d223a9a78df91daa5913f39f97d47681e1e10b8c58b6b462caf1fd56c683129ea732927cf55a06441cde5b743d00582569c9bbf43dab3d7b46ddbf03b358ca6ee075bafcc06165efa8592474bf78732dec4433502579338f2b925a922e74704cf19f7dff414a451fbc24b4ace4a9d8a072fb4259ebc8452941eb9f100f1df0cf19d5718088867a17d52d1c3f1fd5f92c9b9c55cbe528fbfd130879c14bde651a9e402f50b851c753e5915882b02a1136b43e015c6d4fd07e48aa05be08e9faf533a763f21d29a9b7fe8f355a8ffcbf11dc96b1069df4e302a3b310ecf39f25300bb375</span>

<span style=color:#75715e># Integer square root</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>isqrt</span>(x):
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>:
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>&#39;square root not defined for negative numbers&#39;</span>)
    n <span style=color:#f92672>=</span> int(x)
    <span style=color:#66d9ef>if</span> n <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
    a, b <span style=color:#f92672>=</span> divmod(n<span style=color:#f92672>.</span>bit_length(), <span style=color:#ae81ff>2</span>)
    x <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>**</span>(a<span style=color:#f92672>+</span>b)
    <span style=color:#66d9ef>while</span> True:
        y <span style=color:#f92672>=</span> (x <span style=color:#f92672>+</span> n<span style=color:#f92672>//</span>x)<span style=color:#f92672>//</span><span style=color:#ae81ff>2</span>
        <span style=color:#66d9ef>if</span> y <span style=color:#f92672>&gt;=</span> x:
            <span style=color:#66d9ef>return</span> x
        x <span style=color:#f92672>=</span> y

<span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10000</span>):
    phi <span style=color:#f92672>=</span> (e1<span style=color:#f92672>*</span>d1 <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>//</span> k
    
    possible_p <span style=color:#f92672>=</span> (isqrt(n<span style=color:#f92672>*</span>n <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>n<span style=color:#f92672>*</span>(phi<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> (phi<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> n <span style=color:#f92672>-</span> phi <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)<span style=color:#f92672>//</span><span style=color:#ae81ff>2</span>

    <span style=color:#66d9ef>if</span> possible_p <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>and</span> n <span style=color:#f92672>%</span> possible_p <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
        p <span style=color:#f92672>=</span> possible_p
        q <span style=color:#f92672>=</span> n <span style=color:#f92672>//</span> possible_p
        d_boss <span style=color:#f92672>=</span> inverse(e2, phi)
        <span style=color:#66d9ef>print</span>(f<span style=color:#e6db74>&#34;k: {k}, p: {p}&#34;</span>)
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Boss d:&#34;</span>, d_boss)
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Message:&#34;</span>, long_to_bytes(pow(c, d_boss, n)))
        <span style=color:#66d9ef>break</span>
</code></pre></div><p><em>Note: I used a square root function because the solution of the quadratic equations has a square root in it. The <code>isqrt</code> function is a function to approximate the square root to an integer, because Python wouldn&rsquo;t compute the square root of very big integers.</em></p><p>This gives us the following result:</p><p><img src=/image/thcon21/common_modulus.png alt="Challenge solution"></p><p>The flag mentions &ldquo;common modulus&rdquo;. The method I used in this challenge might not be the usual one for common modulus challenges (as far as I remember, I solved common modulus challenges in the past, and I don&rsquo;t recall using a weird square root function), but the maths are correct so it solves the problem anyway ü§∑‚Äç‚ôÇÔ∏è</p></div></div><div id=social-media-share class=has-text-centered><p><i>Sharing is caring!</i></p><br><div class=share-buttons><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Facebook. Opens in a new window."><img src=/img/icons/45px/facebook.png></a>
<a href="https://twitter.com/intent/tweet?text=THCon21%20-%20Rsa%20internal%20attacker&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Twitter. Opens in a new window."><img src=/img/icons/45px/twitter.png></a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Reddit. Opens in a new window."><img src=/img/icons/45px/reddit.png></a>
<a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Pinterest. Opens in a new window."><img src=/img/icons/45px/pinterest.png></a>
<a href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Tumblr. Opens in a new window."><img src=/img/icons/45px/tumblr.png></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f
			&title=THCon21%20-%20Rsa%20internal%20attacker&summary=THCon21%20-%20Blacklisted%20Go%20back%20to%20write-ups%20list%0a%20Category%3a%20Cryptography%0aCreator%3a%20Nico%0aDescription%3a%0aI%26rsquo%3bve%20found%20this%20rsa%20implementation%2c%20it%20is%20quite%20strange.%20I%20have%20a%20public%2fprivate%20key%20and%20I%26rsquo%3bve%20also%20intercepted%20a%20ciphertext%20but%20infortunately%20it%20was%20not%20for%20me%2c%20so%20I%20can%26rsquo%3bt%20read%20it.&source=rafed123.github.io" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on LinkedIn. Opens in a new window."><img src=/img/icons/45px/linkedin.png></a>
<a href="mailto:?subject=THCon21%20-%20Rsa%20internal%20attacker&body=Check out this site https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2frsa-internal-attacker%2f" title="Share via Email. Opens in a new window."><img src=/img/icons/45px/mail.png></a></div></div><br><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><footer class="footer has-background-dark"><div class="content has-text-centered has-text-white"><p>¬© 2020 Ramium. Powered by
<a class=has-text-light href=https://github.com/gohugoio/hugo target=_blank>Hugo</a>. Theme
<a class=has-text-light href=https://github.com/rafed123/ramium/ target=_blank>Ramium.</a></p></div></footer></body></html>